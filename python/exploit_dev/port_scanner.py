# Tyler Gajewski
# Assignment_1 Port_Scanner
# extra credit - dump results into mysql
# Date: 5/19/2015

import socket
import threading
import subprocess
import sys
import MySQLdb

db = MySQLdb.connect(host="localhost", user="root", db="threading")
cur = db.cursor()
cur.execute("delete from results;")

network_argument = sys.argv[1]
list = [20, 21, 22, 23, 25, 69, 445, 134, 135, 464, 990, 989, 1433,1434, 2843, 2844,  80, 139, 443, 8421, 246, 247, 3128, 8080, 8000, 8001, 8002, 465, 587, 9999]
results = []
address_list = []
thread_list = []

def try_ping(ip):
	try:
		ping_result = subprocess.check_output("ping -c 1 %s" % ip, shell=True)
		if "1 received" in ping_result:
			print "Host discovered %s" % ip
			address_list.append(ip)
	except:
		pass

for i in range(1,255):
	temp = "%s.%s" % (network_argument, str(i))
	T = threading.Thread(target=try_ping, args=(temp,))
	thread_list.append(T)
	T.start()

for T in thread_list:
	T.join()

for ip in address_list:
	print "Scanning %s" % ip
	for port in list:
		try:
			sck = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
			sck.settimeout(5)
			sck.connect((ip,port))
			try:
				banner = sck.recv(4096)
				results.append("%i\t%s" % (port, banner))
				try:
					sql = "Insert into results values ('%s','%s','%s')" % (ip,port,banner)
					cur.execute(sql)
					db.commit()
				except:
					db.rollback()
			except:
				results.append("%i\t%s" % (port, "NO BANNER"))
				try:
					sql = "Insert into results values ('%s','%s','%s')" % (ip,port,"NO BANNER")
					cur.execute(sql)
					db.commit()
				except:
					db.rollback()
		except:
			pass
	print "*******[ %s ]*******" % ip
	for k in results:
		print k
	results = []
db.close()
